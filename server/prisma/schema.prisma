generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DailyTransactionType {
  NAKIT_TAHSILAT
  NAKIT_ODEME
  KASA_BANKA_TRANSFER_OUT
  KASA_BANKA_TRANSFER_IN
  BANKA_KASA_TRANSFER_OUT
  BANKA_KASA_TRANSFER_IN
  BANKA_HAVALE_GIRIS
  BANKA_HAVALE_CIKIS
  POS_TAHSILAT_BRUT
  POS_KOMISYONU
  KREDI_KARTI_HARCAMA
  KREDI_KARTI_EKSTRE_ODEME
  CEK_GIRISI
  CEK_TAHSIL_BANKA
  CEK_ODENMESI
  CEK_KARSILIKSIZ
  DEVIR_BAKIYE
  DUZELTME
  KREDI_TAKSIT_ODEME
}

enum DailyTransactionSource {
  KASA
  BANKA
  POS
  KREDI_KARTI
  CEK
  SENET
  DIGER
}

enum CreditCardOperationType {
  HARCAMA
  ODEME
  IADE
  FAIZ
  AIDAT
}

enum ChequeStatus {
  KASADA
  BANKADA_TAHSILDE
  ODEMEDE
  TAHSIL_EDILDI
  ODENDI
  KARSILIKSIZ
}

enum ChequeDirection {
  ALACAK
  BORC
}

enum LoanInstallmentStatus {
  BEKLENIYOR
  ODEME_ALINDI
  GECIKMIS
}

model PosTerminal {
  id            String    @id @default(uuid())
  bankId        String
  name          String    // POS terminal name
  commissionRate Decimal   @db.Decimal(5, 4) // Commission rate (e.g., 0.0250 for 2.5%)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  createdBy     String
  updatedAt     DateTime?
  updatedBy     String?
  deletedAt     DateTime?
  deletedBy     String?

  bank          Bank      @relation(fields: [bankId], references: [id])

  createdByUser User      @relation("PosTerminalCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User?     @relation("PosTerminalUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User?     @relation("PosTerminalDeletedBy", fields: [deletedBy], references: [id])

  @@map("PosTerminal")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  name         String
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime?

  transactionsCreated Transaction[] @relation("TransactionCreatedBy")
  transactionsUpdated Transaction[] @relation("TransactionUpdatedBy")
  transactionsDeleted Transaction[] @relation("TransactionDeletedBy")

  banksCreated Bank[] @relation("BankCreatedBy")
  banksUpdated Bank[] @relation("BankUpdatedBy")
  banksDeleted Bank[] @relation("BankDeletedBy")

  creditCardsCreated CreditCard[] @relation("CreditCardCreatedBy")
  creditCardsUpdated CreditCard[] @relation("CreditCardUpdatedBy")
  creditCardsDeleted CreditCard[] @relation("CreditCardDeletedBy")

  creditCardOperationsCreated CreditCardOperation[] @relation("CreditCardOperationCreatedBy")
  creditCardOperationsUpdated CreditCardOperation[] @relation("CreditCardOperationUpdatedBy")
  creditCardOperationsDeleted CreditCardOperation[] @relation("CreditCardOperationDeletedBy")

  chequesCreated Cheque[] @relation("ChequeCreatedBy")
  chequesUpdated Cheque[] @relation("ChequeUpdatedBy")
  chequesDeleted Cheque[] @relation("ChequeDeletedBy")

  customersCreated Customer[] @relation("CustomerCreatedBy")
  customersUpdated Customer[] @relation("CustomerUpdatedBy")
  customersDeleted Customer[] @relation("CustomerDeletedBy")

  suppliersCreated Supplier[] @relation("SupplierCreatedBy")
  suppliersUpdated Supplier[] @relation("SupplierUpdatedBy")
  suppliersDeleted Supplier[] @relation("SupplierDeletedBy")

  attachmentsCreated Attachment[] @relation("AttachmentCreatedBy")
  attachmentsUpdated Attachment[] @relation("AttachmentUpdatedBy")
  attachmentsDeleted Attachment[] @relation("AttachmentDeletedBy")

  loansCreated Loan[] @relation("LoanCreatedBy")
  loansUpdated Loan[] @relation("LoanUpdatedBy")
  loansDeleted Loan[] @relation("LoanDeletedBy")

  loanInstallmentsCreated LoanInstallment[] @relation("LoanInstallmentCreatedBy")
  loanInstallmentsUpdated LoanInstallment[] @relation("LoanInstallmentUpdatedBy")
  loanInstallmentsDeleted LoanInstallment[] @relation("LoanInstallmentDeletedBy")

  posTerminalsCreated PosTerminal[] @relation("PosTerminalCreatedBy")
  posTerminalsUpdated PosTerminal[] @relation("PosTerminalUpdatedBy")
  posTerminalsDeleted PosTerminal[] @relation("PosTerminalDeletedBy")
}

model Bank {
  id             String    @id @default(uuid())
  name           String
  accountNo      String?
  iban           String?
  openingBalance Decimal?  @db.Decimal(18, 2) // CRITICAL: Opening balance stored in Bank table, NOT as transaction
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  createdBy      String
  updatedAt      DateTime?
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  transactions Transaction[]
  creditCards  CreditCard[]
  depositCheques Cheque[] @relation("ChequeDepositBank") // Çeki tahsile verdiğimiz bankalar
  loans        Loan[]
  posTerminals PosTerminal[]

  createdByUser User  @relation("BankCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("BankUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("BankDeletedBy", fields: [deletedBy], references: [id])
}

model CreditCard {
  id                      String    @id @default(uuid())
  name                    String
  bankId                  String?
  limit                   Decimal?  @db.Decimal(18, 2)
  closingDay              Int?
  dueDay                  Int?
  // Fix Bug 7: Installment configuration fields (minimal, stored on card itself)
  installmentPrincipal    Decimal?  @db.Decimal(18, 2) // Total principal amount for installments
  installmentInterestRate Decimal?  @db.Decimal(18, 4) // Monthly interest rate (e.g., 0.015 for 1.5%)
  installmentBsmvRate     Decimal?  @db.Decimal(18, 4) // BSMV rate (e.g., 0.05 for 5%)
  installmentCount        Int? // Number of installments
  firstInstallmentDate    String? // ISO date string (YYYY-MM-DD)
  // Debt tracking fields
  sonEkstreBorcu          Decimal?  @default(0) @db.Decimal(18, 2) // Last statement balance (manual entry)
  manualGuncelBorc        Decimal?  @db.Decimal(18, 2) // Manual current debt override (null = calculate from operations)
  isActive                Boolean   @default(true)
  createdAt               DateTime  @default(now())
  createdBy               String
  updatedAt               DateTime?
  updatedBy               String?
  deletedAt               DateTime?
  deletedBy               String?

  bank         Bank?                 @relation(fields: [bankId], references: [id])
  operations   CreditCardOperation[]
  transactions Transaction[]

  createdByUser User  @relation("CreditCardCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("CreditCardUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("CreditCardDeletedBy", fields: [deletedBy], references: [id])
}

model CreditCardOperation {
  id                   String                  @id @default(uuid())
  creditCardId         String
  isoDate              String
  type                 CreditCardOperationType
  amount               Decimal                 @db.Decimal(18, 2)
  description          String?
  relatedTransactionId String?
  createdAt            DateTime                @default(now())
  createdBy            String
  updatedAt            DateTime?
  updatedBy            String?
  deletedAt            DateTime?
  deletedBy            String?

  creditCard         CreditCard   @relation(fields: [creditCardId], references: [id])
  relatedTransaction Transaction? @relation(fields: [relatedTransactionId], references: [id])

  createdByUser User  @relation("CreditCardOperationCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("CreditCardOperationUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("CreditCardOperationDeletedBy", fields: [deletedBy], references: [id])
}

model Cheque {
  id                   String          @id @default(uuid())
  cekNo                String
  amount               Decimal         @db.Decimal(18, 2)
  entryDate            String
  maturityDate         String
  status               ChequeStatus
  direction            ChequeDirection
  customerId           String?
  supplierId           String?
  issuerBankName       String          // Çeki düzenleyen banka adı (çekin üstündeki banka) - zorunlu
  depositBankId        String?         // Çeki bankaya tahsile verdiğimiz banka (bizim bankamız) - nullable
  drawerName           String          // Düzenleyen (zorunlu)
  payeeName            String          // Lehtar (zorunlu, default: "Esca Food A.Ş.")
  description          String?
  attachmentId         String?
  imageDataUrl         String?         // MVP: Base64 data URL for cheque image (temporary until Attachment is used)
  // Payment tracking fields (for ODENDI status)
  paidAt               DateTime?
  paidBankId           String?
  paymentTransactionId String?         @unique
  createdAt            DateTime        @default(now())
  createdBy            String
  updatedAt            DateTime?
  updatedBy            String?
  deletedAt            DateTime?
  deletedBy            String?

  depositBank  Bank?         @relation("ChequeDepositBank", fields: [depositBankId], references: [id]) // Bizim bankamız (tahsile verilen)
  customer     Customer?     @relation(fields: [customerId], references: [id])
  supplier     Supplier?     @relation(fields: [supplierId], references: [id])
  attachment   Attachment?   @relation(fields: [attachmentId], references: [id])
  transactions Transaction[]
  paymentTransaction Transaction? @relation("ChequePaymentTransaction", fields: [paymentTransactionId], references: [id])

  createdByUser User  @relation("ChequeCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("ChequeUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("ChequeDeletedBy", fields: [deletedBy], references: [id])
}

model Customer {
  id        String    @id @default(uuid())
  name      String
  phone     String?
  email     String?
  taxNo     String?
  address   String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  createdBy String
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  cheques      Cheque[]
  transactions Transaction[]

  createdByUser User  @relation("CustomerCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("CustomerUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("CustomerDeletedBy", fields: [deletedBy], references: [id])
}

model Supplier {
  id        String    @id @default(uuid())
  name      String
  phone     String?
  email     String?
  taxNo     String?
  address   String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  createdBy String
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  cheques      Cheque[]
  transactions Transaction[]

  createdByUser User  @relation("SupplierCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("SupplierUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("SupplierDeletedBy", fields: [deletedBy], references: [id])
}

model Attachment {
  id         String    @id @default(uuid())
  fileName   String
  mimeType   String
  base64Data String
  createdAt  DateTime  @default(now())
  createdBy  String?
  updatedAt  DateTime?
  updatedBy  String?
  deletedAt  DateTime?
  deletedBy  String?

  transactions Transaction[]
  cheques      Cheque[]

  createdByUser User? @relation("AttachmentCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("AttachmentUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("AttachmentDeletedBy", fields: [deletedBy], references: [id])
}

model Transaction {
  id                String                 @id @default(uuid())
  isoDate           String                 // TARİH / SAAT SÖZLEŞMESİ - 5.1: transactionDate (kullanıcının seçtiği tarih, timezone'suz YYYY-MM-DD, raporlar bunu kullanır)
  documentNo        String?
  type              DailyTransactionType
  source            DailyTransactionSource
  counterparty      String?
  description       String?                // Otomatik + kullanıcı tarafından düzenlenebilir
  category          String?                // Kategori (vergi, maaş, sgk, fatura vs.) - UI'da Açıklama sütununda görünür
  incoming          Decimal                @default(0) @db.Decimal(18, 2)
  outgoing          Decimal                @default(0) @db.Decimal(18, 2)
  bankDelta         Decimal                @default(0) @db.Decimal(18, 2)
  displayIncoming   Decimal?               @db.Decimal(18, 2)
  displayOutgoing   Decimal?               @db.Decimal(18, 2)
  balanceAfter      Decimal                @db.Decimal(18, 2)
  cashAccountId     String?
  bankId            String?
  creditCardId      String?
  chequeId          String?
  customerId        String?
  supplierId        String?
  attachmentId      String?
  loanInstallmentId String?
  transferGroupId   String?                // Links related transfer transactions (BANKA_KASA_TRANSFER pairs)
  createdAt         DateTime               @default(now()) // TARİH / SAAT SÖZLEŞMESİ - 5.1: Sistem zamanı (UTC), audit amaçlı
  createdBy         String                 // KULLANICI / AUTH / AUDIT - 7.1: createdByUserId (User.id)
  createdByEmail    String                 // KULLANICI / AUTH / AUDIT - 7.1: createdByEmail (denormalized for performance, UI'da email gösterilir)
  updatedAt         DateTime?
  updatedBy         String?
  deletedAt         DateTime?
  deletedBy         String?

  bank            Bank?            @relation(fields: [bankId], references: [id])
  creditCard      CreditCard?      @relation(fields: [creditCardId], references: [id])
  cheque          Cheque?          @relation(fields: [chequeId], references: [id])
  chequePayment   Cheque?          @relation("ChequePaymentTransaction")
  customer        Customer?        @relation(fields: [customerId], references: [id])
  supplier        Supplier?        @relation(fields: [supplierId], references: [id])
  attachment      Attachment?      @relation(fields: [attachmentId], references: [id])
  loanInstallment LoanInstallment? @relation("LoanInstallmentTransaction")

  createdByUser User  @relation("TransactionCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("TransactionUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("TransactionDeletedBy", fields: [deletedBy], references: [id])

  creditCardOperations CreditCardOperation[]

  @@index([transferGroupId])
  @@map("transactions")
}

// İŞLEM LOGU (AUDIT LOG) - 8: Tüm değişikliklerin loglanması
model AuditLog {
  id          String   @id @default(uuid())
  actorEmail  String   // KULLANICI / AUTH / AUDIT - 7.1: UI'da gösterilecek
  action      String   // CREATE / UPDATE / DELETE / IMPORT
  entityType  String   // TRANSACTION / BANK / CUSTOMER / SUPPLIER / POS_TERMINAL / CREDIT_CARD / LOAN / CHEQUE
  entityId    String?  // İlgili entity'nin ID'si (opsiyonel)
  summary     String   // İnsan okunur özet
  diff        Json?    // before/after JSON (opsiyonel)
  createdAt   DateTime @default(now())

  @@index([actorEmail])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

model Loan {
  id                   String    @id @default(uuid())
  name                 String
  bankId               String
  totalAmount          Decimal   @db.Decimal(18, 2)
  installmentCount     Int
  firstInstallmentDate String
  annualInterestRate   Decimal   @db.Decimal(18, 4)
  bsmvRate             Decimal   @db.Decimal(18, 4)
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  createdBy            String
  updatedAt            DateTime?
  updatedBy            String?
  deletedAt            DateTime?
  deletedBy            String?

  bank         Bank              @relation(fields: [bankId], references: [id])
  installments LoanInstallment[]

  createdByUser User  @relation("LoanCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("LoanUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("LoanDeletedBy", fields: [deletedBy], references: [id])

  @@map("loans")
}

model LoanInstallment {
  id                String                @id @default(uuid())
  loanId            String
  installmentNumber Int
  dueDate           String
  principal         Decimal               @db.Decimal(18, 2)
  interest          Decimal               @db.Decimal(18, 2)
  bsmv              Decimal               @db.Decimal(18, 2)
  totalAmount       Decimal               @db.Decimal(18, 2)
  status            LoanInstallmentStatus @default(BEKLENIYOR)
  paidDate          String?
  transactionId     String?               @unique
  createdAt         DateTime              @default(now())
  createdBy         String
  updatedAt         DateTime?
  updatedBy         String?
  deletedAt         DateTime?
  deletedBy         String?

  loan        Loan         @relation(fields: [loanId], references: [id], onDelete: Cascade)
  transaction Transaction? @relation("LoanInstallmentTransaction", fields: [transactionId], references: [id])

  createdByUser User  @relation("LoanInstallmentCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("LoanInstallmentUpdatedBy", fields: [updatedBy], references: [id])
  deletedByUser User? @relation("LoanInstallmentDeletedBy", fields: [deletedBy], references: [id])

  @@unique([loanId, installmentNumber])
  @@map("loan_installments")
}
